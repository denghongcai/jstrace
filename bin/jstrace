#!/usr/bin/env node

'use strict';

/**
 * Module dependencies.
 */

const Local = require('../lib/local');
const program = require('commander');
const pkg = require('../package');
const assert = require('assert');
const path = require('path');

// options

program
  .version(pkg.version)
  .usage('[options] <script>')
  .option('-p, --pid <pid>', 'trace with the given <pid>')
  .option('-t, --title <pattern>', 'trace with title matching <pattern>')
  .option('-H, --host <pattern>', 'trace with hostname matching <pattern>')
  .parse(process.argv);

// pid or title

const hostname = program.host;
const title = program.title;
const pid = program.pid;

// script

const script = program.args[0];
assert(script, '<script> path required');

// load the module

const mod = require(path.resolve(script));
assert(mod.local || mod.remote, '.local or .remote required');

// start

const local = new Local({
  remote: mod.remote,
  hostname: hostname,
  title: title,
  pid: pid
});

if (mod.local) mod.local(local);

local.start();

// clean up

process.once('SIGINT', function(){
  local.cleanup(function(err){
    if (err) throw err;
    process.exit(1);
  });

  setTimeout(function(){
    console.error('jstrace cleanup timed out');
    process.exit(1);
  }, 5000);
});
